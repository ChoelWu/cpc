define(function(require,exports,module){require("/static/lib/backbone/backbone-1.0.0.min.js"),require("/static/page/course/common/jquery.nanoscroller.js"),require("/static/css/nanoscroller.css"),require("/static/component/logic/login/tpl/areacode.js");var c=require("./tpl.js"),a=Backbone.View.extend({initialize:function(a){this.tpl=c;this.timer=null,this.hasPass=a.hasPass},events:{"click .tpl-settingPhone .js-getCode":"getMessageCode","click .tpl-settingPhone .js-voicecode-send":"getVoiceCode","click .tpl-settingPhone .js-submit":"clickToSubmit","click  .js-code-tab":"clickAreaCode","click  .js-code-btn":"showAreaCode","click  [data-code]":"setAreaCode","click .js-login-curphone":"loginCurrentPhone"},resendCode:function(){clearInterval(this.timer);var c=60,a=this.$el.find(".js-timer"),h=this;this.timer=setInterval(function(){1>c?(clearInterval(h.timer),"+86"!=$(".js-code-btn").text()?a.addClass("js-getCode active").html("短信接收").css({right:"18px"}):(a.addClass("js-getCode active").html("短信接收"),a.after('<p class="voicecode-send js-voicecode-send"><i class="imv2-vol_up"></i>语音接听</p>'))):(a.removeClass("active").html(c+" s 后重新获取"),$(".js-voicecode-send").remove()),c--},1e3)},getMessageCode:function(){var c=this,a=$(".js-phoneNumber").val();this.blurToCheckPhone(a,function(){c.clickTogetCode(0)})},getVoiceCode:function(){var c=this,a=$(".js-phoneNumber").val();this.blurToCheckPhone(a,function(){c.clickTogetCode(1)})},clickTogetCode:function(c){var a=this.$el.find(".js-phoneNumber").val(),h=this,v=$(".js-code-btn").text();"+86"!=v&&(a=v+a);var g={phone:a,noverify:1};1==c&&(g.typecode=1),$.ajax({url:"/passport/user/getphonelogincode",dataType:"json",data:g,success:function(c){10001==c.status?($(".js-timer").removeClass("js-getCode").css("cursor","default"),h.resendCode()):h.$el.find(".js-gerror").html(c.msg)},error:function(){$(".tpl-settingPhone .js-submit").text("保存"),h.$el.find(".js-gerror").html("系统出错，请稍后重试！")},complete:function(){}})},timerForColse:function(){},showOccupyDialog:function(){var c='<div class="operate-phone">                <div class="keybox">1个手机号只能绑定1个慕课网账号；<br>如需使用该手机号，请登录手机号原绑定账号进行解绑。</div>                <div class="dialogBox yanZhengBox">                    <div class="moco-form-group">                        <label for="inputEmail3" class="moco-control-label btn-box"></label>                        <div class="moco-control-input">                            <a href="javascript:void(0);" class="moco-btn moco-btn-normal cancel-occupy js-modal-close">取消</a>                            <a href="javascript:void(0);" class="moco-btn moco-btn-blue js-login-curphone">登陆原绑定账号</a>                            <p class="js-gerror tl g_error js-error"></p>                        </div>                    </div>                </div>            </div>';$.dialog(c,{title:"该手机号已绑定平台其他账号",modal:!0,width:"456px"})},loginCurrentPhone:function(){var c=$(".js-phoneNumber").val(),a=function(c,a,h){var exp=new Date;exp.setTime(exp.getTime()+1e3*h);var v=c+"="+a+";domain=.imooc.com;path=/;expires="+exp.toGMTString();document.cookie=v};a("last_login_username",c,60),a("loginstate","",0),a("apsid","",0),setTimeout(function(){window.location.href="https://www.imooc.com/user/newlogin"},200)},blurToCheckPhone:function(c,a){var h=c,v=this,g=$(".js-code-btn").text();"+86"!=g&&(h=g+h),moco.validateCallback.rel=!1,$.ajax({url:"/passport/user/checkphone",type:"post",data:{phone:h},dataType:"json",success:function(c){10001==c.status?(moco.validateCallback.rel=!0,"function"==typeof a&&a()):90010==c.status?(moco.validateCallback.errorHint=c.msg,v.showOccupyDialog()):$(".js-phoneNumber").parents(".moco-form-group").find(".moco-control-tip").html(c.msg)},error:function(){moco.validateCallback.errorHint="网络错误"}})},clickToSubmit:function(){if(W.validate(this.$el.find(".tpl-settingPhone"))){var c=this;$(".tpl-settingPhone .js-submit").text("正在保存...");var a=this.$el.find(".js-phoneNumber").val(),h=this.$el.find(".js-phoneCode").val(),v=$(".js-code-btn").text();"+86"!=v&&(a=v+a);var g={};if(g.phone=a,g.code=h,g.noverify=1,!this.hasPass){var j=this.$el.find(".js-pwd").val(),b=this.$el.find(".js-surPwd").val();g.password=j,g.password_confirm=b}$.ajax({url:"/passport/user/bindphone",dataType:"json",data:g,success:function(a){if(10001==a.status){var i=5;$(".js-modal-close").click(),$.dialog('<div class="icon-tick-revert s-right"></div>                                    <div class="finshBox">                                     <p class="success-hint">恭喜你！手机号绑定成功</p>                                    <button class="moco-btn moco-btn-blue js-modal-close js-timer-5">完成[5]</button>                                </div>                                ',{modal:!0,title:"  ",width:488});var h=setInterval(function(){i>0?$(".js-timer-5").text("完成["+i--+"]"):(clearInterval(h),window.location.reload())},1e3)}else c.$el.find(".js-gerror").html(a.msg)},error:function(){util.layerError("系统错误！"),$this.text("立即验证")},complete:function(){$(".tpl-settingPhone .js-submit").text("确定")}})}},showAreaCode:function(){$(".js-code-box").toggle(),0==$(".js-code-list li").length&&this.bindAreaCode(0)},setAreaCode:function(c){var a=$(c.target).data("code");$(".js-code-btn span").text(a),$(".js-code-box").hide(),$(".ipt-phone").focus(),"+86"!=a?($(".js-phoneNumber").attr("data-validate",""),$(".js-phoneNumber").parents(".moco-form-group").find(".moco-control-tip").html(""),$(".js-voicecode-send").hide(),$(".js-getCode").css({right:"18px"})):($(".js-voicecode-send").show(),$(".js-getCode").css({right:"112px"}),$(".js-phoneNumber").attr("data-validate","require-mobile-phone"))},clickAreaCode:function(c){var a=$(c.target);a.addClass("curr").siblings().removeClass("curr"),this.bindAreaCode(a.index())},bindAreaCode:function(c){for(var a=AreaCode[c],h="",i=0;i<a.length;i++)h+='<li data-code="'+a[i].code+'">'+a[i].name+"（+"+a[i].code+" ）</li>";$(".js-code-list").html(h),$(".nano").nanoScroller()},render:function(){clearInterval(this.timer),$.dialog(this.tpl,{modal:!0,title:"绑定手机",width:488,height:"auto"}),this.hasPass&&this.$el.find(".js-hassPassHide").remove()},renderFinish:function(){$(".js-modal-close").click(),$.dialog(' <div class="icon-tick-revert s-right"></div><p class="success-hint">恭喜你绑定成功</p><button class="moco-btn moco-btn-blue "></button>',{modal:!0,title:"绑定手机",width:488}),this.timerForColse()}});module.exports=a});